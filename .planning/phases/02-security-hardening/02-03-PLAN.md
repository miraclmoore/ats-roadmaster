---
phase: 02-security-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - web/sentry.client.config.ts
  - web/sentry.server.config.ts
  - web/sentry.edge.config.ts
  - web/instrumentation.ts
  - web/next.config.ts
  - web/package.json
  - web/package-lock.json
  - web/.env.local
autonomous: true

user_setup:
  - service: sentry
    why: "Error monitoring and performance tracking in production"
    env_vars:
      - name: NEXT_PUBLIC_SENTRY_DSN
        source: "Sentry Dashboard -> Settings -> Projects -> [Your Project] -> Client Keys (DSN)"
      - name: SENTRY_AUTH_TOKEN
        source: "Sentry Dashboard -> Settings -> Account -> Auth Tokens (create new token with project:releases and org:read scopes)"
    dashboard_config:
      - task: "Create new project"
        location: "Sentry Dashboard -> Projects -> Create Project"
        details: "Select Next.js as platform, name it 'roadmaster-pro'"
      - task: "Configure organization and project slugs"
        location: "Sentry Dashboard -> Settings -> General"
        details: "Note your org slug and project slug for next.config.ts"

must_haves:
  truths:
    - Sentry captures errors in client, server, and edge runtimes
    - API keys are scrubbed from error reports before sending to Sentry
    - Performance monitoring samples 10% of requests
    - Session replay captures errors only (not all sessions)
    - Sentry configuration disables logging in development environment
  artifacts:
    - path: web/sentry.client.config.ts
      provides: Client-side error tracking configuration
      contains: "Sentry.init"
      min_lines: 30
    - path: web/sentry.server.config.ts
      provides: Server-side error tracking configuration
      contains: "beforeSend"
      min_lines: 40
    - path: web/sentry.edge.config.ts
      provides: Edge runtime error tracking configuration
      contains: "Sentry.init"
      min_lines: 20
    - path: web/instrumentation.ts
      provides: Next.js instrumentation hook for Sentry
      contains: "register"
      min_lines: 10
    - path: web/next.config.ts
      provides: Sentry webpack plugin integration
      contains: "withSentryConfig"
      min_lines: 5
  key_links:
    - from: web/sentry.server.config.ts
      to: beforeSend hook
      via: PII sanitization
      pattern: "beforeSend.*api_key.*REDACTED"
    - from: web/next.config.ts
      to: "@sentry/nextjs"
      via: withSentryConfig wrapper
      pattern: "withSentryConfig"
---

<objective>
Integrate Sentry error monitoring and performance tracking across all Next.js runtimes (client, server, edge) with PII sanitization.

Purpose: Establish production observability to detect and diagnose errors. Currently using console.error only, which provides no visibility in production deployments. Sentry enables error tracking, performance monitoring, and session replay for debugging.

Output: Sentry initialized in all runtimes with automatic PII scrubbing (API keys redacted), ready for production error capture.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-security-hardening/02-RESEARCH.md
@.planning/phases/02-security-hardening/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Install Sentry Next.js SDK</name>
  <files>web/package.json, web/package-lock.json</files>
  <action>
Install @sentry/nextjs SDK:

```bash
cd web && npm install @sentry/nextjs@8.x
```

Sentry Next.js SDK provides:
- Automatic error capture in all runtimes (client, server, edge)
- Performance monitoring (tracing)
- Session replay for visual debugging
- Source map upload for readable stack traces
- Next.js App Router compatibility
  </action>
  <verify>
```bash
cd web && grep "@sentry/nextjs" package.json
```
Should show @sentry/nextjs as a dependency with version ^8.x.
  </verify>
  <done>package.json contains @sentry/nextjs as a dependency</done>
</task>

<task type="auto">
  <name>Configure Sentry for all runtimes</name>
  <files>web/sentry.client.config.ts, web/sentry.server.config.ts, web/sentry.edge.config.ts, web/instrumentation.ts</files>
  <action>
Create web/sentry.client.config.ts (client-side):

```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,

  // Performance monitoring - 10% sample rate
  tracesSampleRate: 0.1,

  // Session replay - errors only (full replay is expensive)
  replaysOnErrorSampleRate: 1.0, // 100% of errors get replay
  replaysSessionSampleRate: 0.01, // 1% of normal sessions

  // Environment
  environment: process.env.NODE_ENV,

  // Ignore common noise
  ignoreErrors: [
    "ResizeObserver loop limit exceeded", // Browser quirk, not actionable
    "Non-Error promise rejection captured", // Often from third-party code
    "cancelled", // User navigation cancellations
  ],
});
```

Create web/sentry.server.config.ts (server-side with PII sanitization):

```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,

  // Performance monitoring
  tracesSampleRate: 0.1,

  // Environment
  environment: process.env.NODE_ENV,

  // PII sanitization - scrub API keys BEFORE sending
  beforeSend(event, hint) {
    // Scrub API keys from request data
    if (event.request?.data) {
      const data = event.request.data as Record<string, unknown>;
      if (data.api_key) {
        data.api_key = "[REDACTED]";
      }
    }

    // Scrub from breadcrumbs (HTTP requests captured as breadcrumbs)
    if (event.breadcrumbs) {
      event.breadcrumbs = event.breadcrumbs.map(breadcrumb => {
        if (breadcrumb.data?.api_key) {
          breadcrumb.data.api_key = "[REDACTED]";
        }
        return breadcrumb;
      });
    }

    // Scrub from extra context (catch-all for any api_key, token, secret)
    if (event.extra) {
      Object.keys(event.extra).forEach(key => {
        if (key.toLowerCase().includes('key') ||
            key.toLowerCase().includes('token') ||
            key.toLowerCase().includes('secret')) {
          event.extra![key] = "[REDACTED]";
        }
      });
    }

    return event;
  },

  // Ignore common noise
  ignoreErrors: [
    "ResizeObserver loop limit exceeded",
    "Non-Error promise rejection captured",
  ],
});
```

Create web/sentry.edge.config.ts (edge runtime):

```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.1,
  environment: process.env.NODE_ENV,
});
```

Create web/instrumentation.ts (Next.js instrumentation hook):

```typescript
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./sentry.server.config');
  }

  if (process.env.NEXT_RUNTIME === 'edge') {
    await import('./sentry.edge.config');
  }
}
```

**Implementation notes:**
- beforeSend runs BEFORE data leaves the app (secure)
- Scrub api_key, token, secret from all contexts
- 10% performance sampling balances visibility with cost
- Session replay only on errors (full replay is expensive)
- instrumentation.ts required for server-side Sentry initialization
  </action>
  <verify>
```bash
cd web && npx tsc --noEmit sentry.client.config.ts sentry.server.config.ts sentry.edge.config.ts instrumentation.ts
```
Should compile with no errors.

Check PII sanitization:
```bash
grep "REDACTED" web/sentry.server.config.ts
```
Should show API key redaction in beforeSend.
  </verify>
  <done>Sentry configured for all three runtimes with PII sanitization in server config</done>
</task>

<task type="auto">
  <name>Integrate Sentry with Next.js build</name>
  <files>web/next.config.ts</files>
  <action>
Wrap existing Next.js config with Sentry's withSentryConfig.

Read current web/next.config.ts, then wrap it:

```typescript
import { withSentryConfig } from "@sentry/nextjs";

// Your existing Next.js config
const nextConfig = {
  // ... existing config (keep all current settings)
};

// Wrap with Sentry config
export default withSentryConfig(nextConfig, {
  org: process.env.SENTRY_ORG,
  project: process.env.SENTRY_PROJECT,
  authToken: process.env.SENTRY_AUTH_TOKEN,

  // Upload source maps for readable stack traces
  widenClientFileUpload: true,

  // Tunnel requests to avoid ad-blockers blocking Sentry
  tunnelRoute: "/monitoring",

  // Hide source maps from public (security)
  hideSourceMaps: true,

  // Disable during development (reduces noise)
  silent: process.env.NODE_ENV === "development",
});
```

**IMPORTANT:** Preserve ALL existing Next.js config. Only wrap with withSentryConfig, don't replace.
  </action>
  <verify>
```bash
cd web && npx tsc --noEmit next.config.ts
```
Should compile successfully.

Check wrapper:
```bash
grep "withSentryConfig" web/next.config.ts
```
Should show Sentry wrapper around config.
  </verify>
  <done>next.config.ts wrapped with Sentry config while preserving existing settings</done>
</task>

<task type="auto">
  <name>Document Sentry environment variables</name>
  <files>web/.env.local</files>
  <action>
Add Sentry environment variables to web/.env.local:

```bash
# Sentry (error monitoring)
# Get these from: https://sentry.io/settings/[org]/projects/[project]/keys/
# 1. Create Sentry account and project
# 2. Copy DSN from Client Keys (DSN)
# 3. Create auth token: Settings -> Account -> Auth Tokens
#    Required scopes: project:releases, org:read
NEXT_PUBLIC_SENTRY_DSN=https://your-key@o0.ingest.sentry.io/0000000
SENTRY_ORG=your-org-slug
SENTRY_PROJECT=roadmaster-pro
SENTRY_AUTH_TOKEN=your-auth-token-here

# Sentry configuration (optional overrides)
# SENTRY_ENVIRONMENT=production  # Defaults to NODE_ENV
# SENTRY_TRACES_SAMPLE_RATE=0.1  # Defaults to 10%
```

Append to existing .env.local or create if it doesn't exist.
  </action>
  <verify>
```bash
grep "NEXT_PUBLIC_SENTRY_DSN" web/.env.local
```
Should show Sentry DSN variable.

Check gitignore:
```bash
git check-ignore web/.env.local
```
Should output "web/.env.local" (file is ignored).
  </verify>
  <done>.env.local contains Sentry environment variables with setup instructions</done>
</task>

</tasks>

<verification>
1. @sentry/nextjs installed successfully
2. All Sentry config files compile without TypeScript errors
3. beforeSend hook scrubs api_key, token, secret from events
4. instrumentation.ts exports register function
5. next.config.ts wrapped with withSentryConfig
6. Environment variables documented in .env.local
</verification>

<success_criteria>
- Sentry initialized in client, server, and edge runtimes
- PII sanitization verified in beforeSend hook (api_key â†’ [REDACTED])
- Performance monitoring sampling at 10%
- Session replay configured for errors only
- Build succeeds with Sentry integration
- Developer has clear instructions for Sentry account setup
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-hardening/02-03-SUMMARY.md`
</output>
